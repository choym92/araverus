<!-- Created: 2026-02-23 -->
# Handoff: UI Polish + Importance Re-rank

## What Was Done

### 1. ArticleCard UI Polish (`src/app/news/_components/ArticleCard.tsx`)
- **Thread bar**: `bg-neutral-50 rounded-lg` + Lucide `ChevronLeft/ChevronRight` + emoji removed + `text-neutral-600 font-medium` title
- **Keywords**: Pill → inline text with `·` separator, alphabetical, capitalize first char (`KeywordPills.tsx`)
- **"via Source"**: Moved to top-right (same row as category + timestamp) for both featured + standard
- **must_read glow**: `border-l-2 border-amber-400` → `shadow-[0_2px_20px_rgba(245,158,11,0.2)]` amber glow + elevated card (both variants)
- **Thread fixed height**: `h-36` for standard variant, `line-clamp-3` for thread cards
- **Thread bar spacing**: `mt-1 px-2 py-2 gap-1`
- **Featured thread bar**: `justify-center`

### 2. Importance Re-rank in Curation (Notebook: `notebooks/briefing_prototype.ipynb`)

**Cell 9** — Combined curation + importance re-rank in ONE Gemini Pro call:
- Prompt returns `{"curated": [3,7,12], "importance": ["optional","worth_reading","must_read",...]}`
- Compact array format (not per-object) saves tokens
- Thinking budget: 2048

**Prompt improvements applied:**
- must_read flexible: "typically 3-5, up to 7 on heavy days, 1-2 on quiet days"
- Dedup protection: "Primary article MUST keep true importance. Never demote major story just because duplicates exist"
- Crawl failure protection: "Do NOT penalize for less context. Judge by EVENT itself"
- TECH rule: "categorized under Technology or AI-related" (not "[TECH] tag")
- TECH overflow: "If exceeds 15, keep highest-impact within limit"
- Recency signal: `| 14h ago` added to each article line
- Recency tie-break: "favor more recent when similarly impactful"

**Cell 6** — Added `importance,keywords` to `wsj_llm_analysis` select (was missing)

**Cell 3** — `briefed` filter commented out for testing (TEMP — re-enable before production)

**Cell 11** — Assemble articles with summary fallback:
- Curated: full content → summary → description
- STD: summary → content[:800] → description
- Title-only: description → title
- Curated articles NO LONGER require successful crawl

## Test Results (Cell 9) — Multiple Runs

**Run 2 (latest):** 80 articles → 12 curated, 5 must_read
- must_reads: Fed Rate Pause, EU Trade Deal halt, Gilead $7.8B, Netflix/Susan Rice, 15% global tariff
- #76 Supreme Court tariff → worth_reading (inconsistent — was must_read in run 1)
- #47 Netflix/Susan Rice → must_read (questionable — may not warrant must_read)
- Tokens: in 6,208, out 531, thinking 5,289/2,048

**Run 1:** 80 articles → 13 curated, 4 must_read
- must_reads: Fed Rate Pause, Gilead $7.8B, 15% global tariff, Supreme Court tariff
- #76 Supreme Court tariff correctly must_read
- Tokens: in 6,208, out 535, thinking 1,851/2,048

**Note:** temperature=0.1 causes slight variation between runs. Consider 0.0 for more consistency.

**Cell 11 — Assemble with summary fallback verified:**
- CURATED: 12 articles with full content (2K-20K chars)
- STD: 61 articles with summary (~800-1,100 chars) — working correctly
- TITLE-only: 7 articles with description only
- Summary fallback successfully replaces content[:800] truncation

## Still TODO

### Next Session TODO (in order)

**1. DB: Add `importance_reranked` column to `wsj_llm_analysis`**
- Column: `importance_reranked TEXT` (same values: must_read/worth_reading/optional)
- This keeps original per-article `importance` intact for comparison

**2. Update `scripts/generate_briefing.py`**
Apply all notebook changes:

a) **`CURATION_PROMPT`** — replace with cell 9 version:
   - Combined curation + importance re-rank in one call
   - Compact output: `{"curated": [...], "importance": ["optional", ...]}`
   - Flexible must_read (3-5, up to 7), dedup protection, crawl failure protection
   - `published_at` recency signal (`| 14h ago`) in article lines
   - Thinking budget 1024 → 2048

b) **`curate_articles()`** — parse new response format:
   - Extract `curated` (indices) + `importance` (array)
   - Return both `curated_ids` and `importance_array`

c) **Save `importance_reranked` to DB** — after curation, loop through `importance_array` and update `wsj_llm_analysis.importance_reranked` for each article

d) **`assemble_articles()`** — summary fallback chain:
   - Curated: full content → summary → description
   - STD: summary → content[:800] → description
   - Title-only: description → title
   - Curated articles can be title-only (remove `has_quality` gate)
   - Requires `summary` in `llm_map` select (already fetched)

**3. Update docs**
- `docs/schema.md` — add `importance_reranked` column
- `docs/4-news-backend.md` — update briefing generation section
- `docs/4-news-frontend.md` — note `importance_reranked` usage

**4. Frontend (after DB + backend done)**
- `news-service.ts` — prefer `importance_reranked` over `importance` for card display

### NOT doing yet
- Do NOT run `generate_briefing.py` — just update the code
- Do NOT simplify `llm_analysis.py` 1차 prompt yet — do after validating 2차 in production
- Re-enable `briefed` filter in notebook cell 3 before any production test

## Key Files
- `src/app/news/_components/ArticleCard.tsx` — card UI changes
- `src/app/news/_components/KeywordPills.tsx` — inline keyword style
- `notebooks/briefing_prototype.ipynb` — importance re-rank experiment (cells 9, 11)
- `scripts/generate_briefing.py` — production briefing (needs updates from notebook)
- `scripts/llm_analysis.py` — per-article LLM prompt (can simplify importance)
- `docs/schema.md` — needs `importance_reranked` column added

## Architecture Decision
- **2-stage importance**: 1차 per-article (absolute, Gemini Flash) + 2차 re-rank (relative, Gemini Pro during curation)
- **No extra LLM call** — re-rank piggybacks on existing curation call
- **Store both** — `importance` (original) + `importance_reranked` (relative) for comparison/analysis
