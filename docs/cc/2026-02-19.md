<!-- Updated: 2026-02-19 -->
# Session Handoff — 2026-02-19

## What Was Done

**Refactored domain blocking: JSON file → DB-only**
- Removed `scripts/data/blocked_domains.json` (63 blocked domains)
- Consolidated blocking logic from 3 separate implementations into shared DB-only pattern
- Added one-time migration: `--seed-blocked-from-json` flag to `wsj_ingest.py`
- Updated 5 scripts to use DB (`wsj_domain_status`) instead of local JSON
- Added in-memory `run_blocked` set to `crawl_ranked.py` for same-run failure tracking
- Updated docs + linted all changes

**Commits:**
- `e1929ca` refactor: remove blocked_domains.json, DB-only domain blocking (7 files, -693 LOC)

---

## What Was Done (Session 2)

**Investigated News API as fallback for uncrawled WSJ articles**

### Analysis Phase
- Queried Supabase to measure actual content gap:
  - **Real usable content** (is_same_event=true + has summary): 19-72% per day (not 34-89% as initially measured)
  - Recent 2 days (2/18-19): only **19-21% success** — significantly worse than historical average
  - Root cause: ~35% of crawls are "wrong event" (Google News matching issue) + social media sites failing
  - No images for recent 2 days (0/38, 0/63), older days have ~50% image coverage

### NewsData.io API Testing
1. **Created notebook** (`notebooks/newsdata_api_test.ipynb`) to evaluate NewsData.io as fallback
2. **Free tier analysis:**
   - 200 credits/day (1 credit per search)
   - Returns: title, description (~200-400 chars), image_url, keywords, link, source_name
   - **Does NOT return:** full content (paid only), ai_summary (paid only)
   - 12-hour delay on free tier (acceptable for fallback)

3. **Search strategy testing:**
   - **Full title as `q`**: 0 results — ALL words become AND filter
   - **`qInTitle` + AND operator**: 5 results — better but still requiring exact title words
   - **Entity + topic** (manual keywords like "Walmart earnings"): 9/10 match rate (90%) ✓ Best so far
   - **Timing insight:** 1-2 days delay = better matching (other outlets catch up on same event)

### Key Findings
1. **API works well for image + description fallback**: 90%+ image rate, descriptions useful for card display
2. **Matching improves with time**: Same-day WSJ article → API fallback next day when other outlets cover
3. **Manual keyword extraction needed**: Full title won't work, needs "Company + Topic" (2-3 words)
4. **Free tier sufficient**: 35-50 uncovered items/day << 200 daily credits

### Technical Gotchas Found
- `q`, `qInTitle`, `qInMeta` are mutually exclusive (API rejects if >1 used)
- Full title with AND logic = 0 results (too restrictive)
- `timeframe` parameter requires paid plan
- Rate limit: 30 requests/15 minutes (hit it mid-test, need 1 sec delays)

## Key Decisions

1. **NewsData.io for fallback**: image + description good enough for cards (content not critical for display)
2. **Async 1-2 day fallback**: Don't use API on same day (matching poor), batch run next day when more outlets cover
3. **Entity extraction required**: Need to extract "Company + Topic" from WSJ title automatically (LLM or rules-based)
4. **Skip `qInMeta` / `q` with full title**: Use simple first-N-words or entity-only extraction

## Files Changed

| File | Change |
|------|--------|
| `notebooks/newsdata_api_test.ipynb` | NEW — API testing playground with 3 strategy comparisons |
| Git | No commits yet (testing phase) |

## Remaining Work

- [ ] **Fix entity extraction logic** — move from manual dict to automatic rule (first proper noun + generic topic word)
- [ ] **Implement fallback pipeline** — add NewsData.io search stage for items with no same-event crawl after 1+ days
- [ ] **Store API results** — add table `wsj_api_fallback` or columns to `wsj_crawl_results` for API-sourced data
- [ ] **Handle image URLs** — decide: hotlink WSJ images, hotlink API images, or re-host (re-host safest)
- [ ] **Test full integration** — wire up end-to-end: uncrawled items → API search → DB → frontend display
- [ ] **Run one-time DB migration** (`python scripts/wsj_ingest.py --seed-blocked-from-json`) — deferred from previous session

## Blockers / Questions

1. **API key rotation needed** — notebook had API key visible, should rotate before deploying
2. **qInMeta full-title test incomplete** — rate limit hit, need to retry after cooldown (15 min from 16:25 UTC)
3. **Entity extraction approach unclear** — manual keywords work but not scalable; LLM or regex rules?
   - Options: (a) Gemini Flash to extract entity+topic from title, (b) Regex rules for common patterns, (c) NER on title
4. **Schema design pending** — where to store API results (new table vs existing wsj_crawl_results columns)?

## Context for Next Session

**Current content gap:**
- 38-63 RSS items/day
- 19-72% with usable same-event crawl content (real measured value, not headline number)
- 25-51 uncovered items/day needing fallback
- NewsData.io: 200 credits/day > 50 searches/day ✓ sufficient

**Recommended next steps:**
1. Wait 15+ minutes, retry qInMeta with full title (low priority — already know entity+topic works 90%)
2. Build entity extractor (rule-based or LLM) — "Walmart Sales Climb" → "Walmart sales"
3. Design fallback table schema (minimal: wsj_item_id, api_source, description, image_url, link, fetched_at)
4. Integrate into pipeline: after 1+ days with no same-event crawl, trigger API search
5. Rotate API key before deploying

**Nice-to-have insights:**
- Full title `q` search = 0 results because of AND logic
- Meta keywords search (`qInMeta`) might improve with full title (untested due to rate limit)
- Image sourcing: API images are from news outlets, less risky than direct scrape (no DMCA violation, just hotlink)
- Timing: 1-2 day delay improves matching because more outlets cover same news event

---

---

## What Was Done (Session 3)

**Compared GNews vs NewsData.io with 3-word entity+keyword queries**

### API Comparison Testing
1. **GNews API evaluation** (`notebooks/newsdata_api_test.ipynb`):
   - Tested 10 WSJ titles with entity+keyword extraction (e.g., "Walmart sales grocery")
   - Free tier: 100 req/day, **content is ALWAYS ~266 chars truncated** (cannot get full content without paid)
   - Date filter: `from`/`to` parameters work on free tier ✓
   - Search operators: AND/OR/NOT supported, relevance sorting works ✓
   - Results: 5/10 matched (50%), all had images, all had content (though truncated)

2. **NewsData.io retry** (same 10 queries):
   - Same entity+keyword approach as GNews
   - Rate limit hit: 30 req/15min (tighter than GNews)
   - Free tier: 200 credits/day, NO content on free (paid only)
   - Expected vs actual: 50% match rate vs 50% (similar to GNews)

3. **Content quality analysis**:
   - GNews truncated content (266 chars) + description (150-350 chars) = **400-600 chars total**
   - Enough for AI to extract key facts, but still at risk of hallucination if content is unrelated
   - Matching accuracy: 5/10 matched, but only 2/5 were **same event** (Prince Andrew, Nestle ice cream)
   - Other 3 were **same topic, different story** (Walmart grocery penetration ≠ Walmart sales climb)

### Key Finding: Same-Event vs Same-Topic Problem
- **Entity+keyword searches DON'T guarantee same event**
- Example: "US trade deficit" returned Trump tariff claims (conflicting perspective, not same event)
- Example: "Rio Tinto Glencore" returned Rio Tinto earnings (not Glencore deal news)
- Root cause: keyword search matches topic words, not news events
- **Implication**: Even with API content, can't reliably use it for AI summarization without hallucination risk

### Experiments Attempted (failed)
- Full title search with both APIs = 0 results (AND logic too restrictive)
- Different timeframe windows (2-day, 7-day) = same 50% match rate
- Special characters in queries = syntax errors (GNews rejected punctuation)

## Key Decisions

1. **GNews truncated content is OK for images** — use API for image sourcing only, not content
2. **Don't use API content for AI summarization** — risk of mixing unrelated stories (different events with same keywords)
3. **API fallback purpose shifts** — from "provide content for summary" to "provide images + description for cards"
4. **Need better entity matching** — keyword search insufficient, need semantic matching or timeline-based approach

## Files Changed

| File | Change |
|------|--------|
| `notebooks/newsdata_api_test.ipynb` | Added 3 new cells: GNews batch test v3, GNews results viewer, NewsData.io retry |
| `notebooks/gnews_results_full.txt` | NEW — full text dump of all GNews results (for content analysis) |
| Git | No commits (testing phase) |

## Remaining Work

- [ ] **Decide on API usage strategy** — image-only vs image+description for cards?
- [ ] **Build image caching** — if using API images, decide: hotlink vs re-host vs fallback
- [ ] **Keep NewsData.io testing** — might be useful for image sourcing since no content truncation on images
- [ ] **Revisit Google News matching** — 35% "wrong event" rate is still main bottleneck, not API gap
- [ ] **Run one-time DB migration** (`python scripts/wsj_ingest.py --seed-blocked-from-json`) — deferred since session 1

## Blockers / Questions

1. **Is API content worth using?** — YES for images, NO for summarization (hallucination risk with unrelated stories)
2. **GNews free tier content truncation** — can't get full content without $84/mo paid plan
3. **Matching accuracy plateau** — 50% match rate appears to be ceiling for keyword-based search across both APIs
4. **NewsData.io 12-hour delay** — was proposed to improve matching, but untested (never got past 2-day window tests)

## Context for Next Session

**Critical insight from this session:**
- The content gap problem (19-72% coverage) is NOT primarily an API coverage problem
- It's a **Google News matching problem** — 35% of crawled articles are "wrong event"
- Adding API fallback with same keyword-search approach won't improve much
- **Better use of API**: Image sourcing (100% available on free tier)

**What we learned about the APIs:**
- Both GNews and NewsData.io: 50% match rate with entity+keyword queries
- GNews: Better for truncated content (266 chars), clean API
- NewsData.io: No content on free, but images available
- Rate limits: NewsData (30/15min) < GNews (100/day)
- Both suffer from: keyword matching = topic matching ≠ event matching

**Recommended approach for next session:**
1. Accept 50% API match rate as ceiling with keyword search
2. Pivot: use API **images only**, keep content from WSJ RSS
3. Focus on improving Google News matching (the real bottleneck)
4. OR explore semantic search (CLIP/embedding matching) instead of keyword search

**API decision checklist:**
- [ ] Do we want images from API? (✓ yes, useful)
- [ ] Do we want descriptions from API? (maybe — but verify no hallucination in summarization)
- [ ] Do we want content from API? (✗ no — truncated + hallucination risk)
- [ ] Timeline: batch API calls 1-2 days later, or same-day? (skip for now, not validated)

---

## What Was Done (Session 4)

**Comprehensive 3-API comparison for content gap fallback**

### APIs Tested
1. **GNews** — Free: 100 req/day, content truncated to 266 chars, `in` param (title+desc+content), `from`/`to` free, `sortby=relevance`
2. **NewsData.io** — Free: 200 credits/day, NO content on free, `q`/`qInTitle`/`qInMeta` mutually exclusive, `timeframe` paid only, rate limit 30/15min
3. **NewsAPI.org** — Free: 100 req/day, content truncated to 200 chars, `domains` filter, `searchIn` param, `from`/`to` free, `sortBy=relevancy`/`popularity`/`publishedAt`

### Test Matrix (10 WSJ articles from 2026-02-19)

All tests used **entity+keyword queries** (2-3 words manually extracted from WSJ title).

#### Baseline Tests (entity+keyword, 2-day window, no extra filters)

| API | Match Rate | Same-Event | Same-Topic+ | Notes |
|-----|-----------|-----------|-------------|-------|
| GNews Baseline | 5/10 (50%) | 2/10 | 4/10 | Best accuracy-to-match ratio |
| NewsData Baseline | 7/10 (70%) | 2/10 | 3/10 | Highest match count but low quality |
| NewsAPI Baseline | 8/10 (80%) | 1/10 | 3/10 | Most matches but worst accuracy — earthworms, gossip |

#### Enriched Tests (added WSJ RSS metadata as API filters)

| API | Strategy | Match Rate | vs Baseline | Quality |
|-----|----------|-----------|-------------|---------|
| GNews Enriched | +country=us, ±24h date | 5/10 (50%) | = same | Accuracy improved (3/5 same-event = 60%) |
| NewsData Enriched | +category, +prioritydomain=top, +image=1 | 4/10 (40%) | ↓ worse | Filters too aggressive, lost Klarna/Etsy/Prince Andrew |
| NewsAPI Enriched | +domains (13 quality sites), +searchIn | **0/10 (0%)** | ↓↓ dead | `domains` + `searchIn` + `±24h` = zero results |

### Per-Article Same-Event Results (Union of All APIs)

| # | WSJ Title | Best API | Same-Event? | Best Match |
|---|-----------|----------|-------------|------------|
| 1 | Walmart Sales Climb, Driven by Grocery | NewsAPI | ✓ | "Walmart earnings CEO Furner" [Yahoo] |
| 2 | Klarna Swings to Loss | — | ✗ | All wrong (class action, Vogue tracker) |
| 3 | U.S. Trade Deficit Grew in December | GNews | ~ | "Trump claims 78% drop" (same topic, diff angle) |
| 4 | Etsy Posts Lower Profit | — | ✗ | All wrong (earthworms, eBay Depop) |
| 5 | Hims & Hers Acquire Eucalyptus | — | ✗ | No match on any API |
| 6 | Prince Andrew Arrested Amid Epstein | GNews/NewsData | ✓ | "Prince Andrew arrested" [Breitbart/ARY] |
| 7 | Wayfair Loss Narrows | NewsAPI | ~ | "retailers vulnerable to bankruptcy" [Retail Dive] |
| 8 | Rio Tinto + Failed Glencore Talks | NewsData | ✓ | "Rio Tinto copper after Glencore talks fail" [FT] |
| 9 | Elizabeth Warren Fed Regulator | — | ✗ | No match on any API |
| 10 | Nestle Shed Ice-Cream Business | GNews | ✓ | "Nestle Q4 + plans ice cream sale" [Reuters] |

**Union same-event coverage: 4/10 (40%)**
**Union same-topic coverage: 6/10 (60%)**
**Total no-match: 4/10 (Klarna, Etsy, Hims&Hers, Elizabeth Warren)**

### Key Findings

1. **Keyword search ceiling is ~40% same-event** — all 3 APIs combined only yield 4/10 same-event matches
2. **Adding filters makes results WORSE** — `domains`, `category`, `prioritydomain` all reduce matches without improving accuracy
3. **Each API covers different articles** — no single API is best for all; union strategy needed
4. **Niche companies = no coverage** — Klarna, Etsy, Wayfair, Hims&Hers don't appear in free API results
5. **US-specific political/regulatory stories fail** — Elizabeth Warren Fed regulator = 0 results everywhere
6. **Big breaking news works best** — Prince Andrew arrest = all 3 APIs found it
7. **NewsAPI has most matches (80%) but worst quality** — no domain filter = earthworms, Cosmopolitan gossip
8. **GNews has best balance** — 50% match, 40% same-event among matches (2/5)
9. **NewsData unique strength** — FT article for Rio Tinto/Glencore was only true same-event match from any API for that article

### API Parameter Reference

**GNews `/v2/search`**:
- `q` (AND/OR/NOT, `"phrase"`), `in` (title,description,content), `from`/`to`, `sortby` (relevance/publishedAt), `country`, `lang`, `max` (1-10), `nullable` (image), `expand` (content — paid)
- Free: 100 req/day, content always 266 chars truncated
- No `topic` filter on /search (only /top-headlines)

**NewsData.io `/api/1/latest`**:
- `q`/`qInTitle`/`qInMeta` (MUTUALLY EXCLUSIVE — pick one), `category`, `country`, `language`, `domain`/`domainurl`, `prioritydomain` (top/medium/low), `image` (1), `removeduplicate` (1), `size` (1-10), `timeframe` (PAID ONLY)
- Free: 200 credits/day, NO content, rate limit 30/15min
- `keywords`, `source_name`, `source_priority` in response (useful for filtering)

**NewsAPI.org `/v2/everything`**:
- `q` (AND/OR/NOT, `"phrase"`), `searchIn` (title,description,content), `sources`/`domains` (mutually exclusive), `excludeDomains`, `from`/`to`, `language`, `sortBy` (relevancy/popularity/publishedAt), `pageSize` (max 100)
- Free: 100 req/day, content 200 chars truncated
- `domains` filter too restrictive with keyword search — 0/10 when combined

### WSJ RSS Metadata Available for Enrichment

From `wsj_items` table:
- `feed_name`: ECONOMY, WORLD, BUSINESS_MARKETS, TECH → maps to API category/topic
- `subcategory`: retail, earnings, trade, uk, deals, regulation, currencies
- `published_at`: precise timestamp → can narrow API date window
- `description`: WSJ's own summary (~60 chars truncated in DB) → additional keywords
- `creator`: author name → not useful for API filtering
- `slug`: URL slug → not useful for API filtering

Feed-to-API mapping:
```
ECONOMY        → GNews: country=us   | NewsData: category=business
WORLD          → GNews: country=*    | NewsData: category=world
BUSINESS_MARKETS → GNews: country=us | NewsData: category=business
TECH           → GNews: topic=tech   | NewsData: category=technology
```

### Why Enrichment Failed

1. **`domains` whitelist** (NewsAPI): Quality domains (reuters, cnbc, bloomberg...) don't cover niche company earnings with entity+keyword queries in ±24h window → 0/10
2. **`prioritydomain=top`** (NewsData): Filtered out small-source results that were actually the only matches for niche companies → 70% → 40%
3. **`category` filter** (NewsData): API category classification doesn't match WSJ feed_name → Prince Andrew "world" articles not categorized as "world" in API
4. **`country=us`** (GNews): Minor effect — already mostly US sources, but pulled in random local news ("The Stroller, Alle-Kiski Valley")
5. **`image=1`** (NewsData): Removed text-only results that had good descriptions
6. **Date narrowing** (±24h vs 2-day): Minimal effect since articles are recent and window similar

**Conclusion: Filters are counterproductive. Keep searches broad (baseline) and filter results AFTER retrieval using AI/embedding similarity.**

## Key Decisions

1. **Use all 3 APIs in parallel** — each covers different articles, union gives best coverage
2. **No domain/category filters** — they reduce matches without improving quality
3. **Post-retrieval filtering > pre-query filtering** — use AI to verify same-event after getting results
4. **40% same-event ceiling with keyword search** — need semantic approach for better matching
5. **Free tiers sufficient** — 100+200+100 = 400 daily credits >> 50 uncovered items/day

## Files Changed

| File | Change |
|------|--------|
| `notebooks/newsdata_api_test.ipynb` | Added cells 23-32: WSJ metadata setup, GNews/NewsData enriched tests, NewsAPI setup+baseline+enriched, grand comparison |
| `notebooks/gnews_results_full.txt` | Existing — GNews results dump |
| Git | No commits (testing phase) |

## Remaining Work

- [ ] **Build post-retrieval same-event classifier** — LLM or embedding similarity to filter API results after search
- [ ] **Implement union fallback pipeline** — search all 3 APIs, pick best same-event match
- [ ] **Explore semantic search** — embedding WSJ title+description vs API results for matching
- [ ] **Test with more articles** — 10-article sample is small, need 30-50 for reliable stats
- [ ] **Automate entity+keyword extraction** — currently manual, need LLM or rule-based extraction
- [ ] **Rotate API keys** — all 3 keys visible in notebook
- [ ] **Run one-time DB migration** (`python scripts/wsj_ingest.py --seed-blocked-from-json`) — deferred since session 1

## Blockers / Questions

1. **Is 40% same-event enough?** — Combined with existing 19-72% crawl coverage, total could be ~60-85%
2. **Post-retrieval filtering approach** — Use Gemini Flash to compare WSJ title vs API title? Or embedding cosine similarity?
3. **API key management** — 3 keys to manage, need env var standardization
4. **Rate limit coordination** — if using all 3 APIs in pipeline, need staggered calls
5. **Content truncation** — GNews 266ch + NewsAPI 200ch = enough for AI same-event verification?

## Context for Next Session

**The content gap problem now has data:**
- Keyword-based API search: 40% same-event ceiling (union of 3 APIs)
- Individual API strengths: GNews (accuracy), NewsData (volume + FT access), NewsAPI (broadest matches)
- Enrichment (adding filters) = counterproductive — makes results worse
- Real bottleneck: keyword matching ≠ event matching → need semantic approach

**Recommended next steps:**
1. Build same-event classifier (LLM prompt: "Are these two headlines about the same news event?")
2. Use union of all 3 APIs with broad search, then filter with classifier
3. Test with 30+ articles to validate 40% figure
4. If semantic approach works, expected coverage: 60-70% same-event (vs current 19-72% crawl)

## Git Activity
```
5ef6926 feat: detail page redesign, related articles overhaul, collapsible timeline
```

(Earlier session domain refactor + NewsData migration still pending)

---
## Git Activity (auto-logged)
```
484593a feat: add hardcoded UNCRAWLABLE_DOMAINS for instant SNS blocking
f0822fb docs: add session handoff for 2026-02-19
5ef6926 feat: detail page redesign, related articles overhaul, collapsible timeline
e1929ca refactor: remove blocked_domains.json, DB-only domain blocking
c07feae fix: remove preferred domain logic, fix JSONB storage for briefings
```
