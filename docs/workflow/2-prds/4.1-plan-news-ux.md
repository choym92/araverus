<!-- Updated: 2026-02-18 -->
# Plan: News Page UX — All Phases

## Goal

Transform the flat news page into a threaded, keyword-filterable feed with article detail pages, story timelines, and heat-based ranking.

---

## Phase 1-2: Backend + Initial Frontend (DONE)

All pipeline and initial frontend work is complete.

### Phase 1 — Keywords + Embeddings + Threading ✅

| Step | Status | What was done |
|------|--------|---------------|
| 1a. Keywords in LLM prompt | ✅ | `llm_analysis.py` generates 2-4 keywords per article, stored in `wsj_llm_analysis.keywords TEXT[]` |
| 1b. pgvector + embeddings table | ✅ | `wsj_embeddings` with `vector(768)` (BAAI/bge-base-en-v1.5), ivfflat index |
| 1c. Embed + Thread pipeline | ✅ | `embed_and_thread.py` — centroid matching + LLM grouping + anti-gravity (v3.3). See `docs/4-news-threading.md` |
| 1d. NewsService updates | ✅ | `getNewsItems()` includes keywords + thread_id, `getStoryThread()`, `getThreadTimeline()` |
| 1e. `/news` page layout | ✅ | Thread-grouped layout with category filter, keyword filter bar |
| 1f. Components | ✅ | `KeywordPills`, `ArticleCard` (3 variants), `NewsShell`, `BriefingPlayer` |

**Key differences from original plan:**
- Clustering → Threading (persistent cross-day threads instead of daily clusters)
- `all-MiniLM-L6-v2` → `BAAI/bge-base-en-v1.5` (768-dim, better quality)
- OpenAI → Gemini 2.5 Flash for all LLM calls
- Thread algorithm v3.3 with anti-gravity, hard cap, margin check

### Phase 2 — Article Detail Page ✅

| Step | Status | What was done |
|------|--------|---------------|
| 2a. `/news/[slug]/page.tsx` | ✅ | Server Component, article detail with metadata |
| 2b. NewsService methods | ✅ | `getNewsItemBySlug()`, `getRelatedArticles()`, `getMoreLikeThis()`, `getThreadTimeline()` |
| 2c. Article card links | ✅ | Cards link to `/news/[slug]` with "Read original" secondary link |

**Not yet implemented from Phase 2:**
- [ ] RelatedArticles component (pgvector RPC `match_articles` exists but frontend component not built)
- [ ] MiniTimeline component (service method exists, no component)
- [ ] MoreLikeThis component (service method exists, no component)

---

## Phase 3: Thread UX Enhancements (NEXT)

### Scope (confirmed)

3 features. No importance filter, no Stories/Search tabs.

1. **Thread title** — Show `wsj_story_threads.title` instead of generic "N articles"
2. **Expand/collapse** — Thread groups collapsible (show lead article, expand for all)
3. **Heat score ranking** — Sort thread groups by heat (hottest first)

### Current Problems

```tsx
// page.tsx line 289-293 — thread title is WRONG
<h2>{group.articles[0]?.feed_name
  ? `${group.articles.length} articles`  // ← shows count, not title
  : 'Related Stories'}</h2>
```

- Thread groups rendered in arbitrary Map order (no heat ranking)
- All articles in a thread always visible (no collapse)
- `page.tsx` is a Server Component — expand/collapse needs a Client Component wrapper

### Implementation

#### Step 1: `news-service.ts` — Add `getThreadsByIds()`

Batch fetch thread metadata for all thread IDs in one query.

```typescript
async getThreadsByIds(threadIds: string[]): Promise<Map<string, StoryThread>> {
  const { data } = await this.supabase
    .from('wsj_story_threads')
    .select('id, title, member_count, first_seen, last_seen')
    .in('id', threadIds)
  // Return as Map<id, StoryThread>
}
```

#### Step 2: `page.tsx` — Add `computeHeatScore()`

Pure function, no DB needed. Takes thread's articles, returns heat number.

```typescript
function computeHeatScore(articles: NewsItem[]): number {
  const weights = { must_read: 3, worth_reading: 2, optional: 1 }
  const now = Date.now()
  return articles.reduce((sum, a) => {
    const daysOld = (now - new Date(a.published_at).getTime()) / 86400000
    const w = weights[a.importance as keyof typeof weights] ?? 1
    return sum + w * Math.exp(-0.3 * daysOld)
  }, 0)
}
```

#### Step 3: `page.tsx` — Fetch titles + sort by heat

In `NewsPage()`:
1. After `groupByThread()`, collect unique thread IDs
2. Call `service.getThreadsByIds(threadIds)`
3. Compute heat score per group
4. Sort groups by heat descending
5. Pass data to ThreadSection client component

#### Step 4: Create `ThreadSection.tsx` (Client Component)

New file: `src/app/news/_components/ThreadSection.tsx`

- Shows thread title + article count badge
- Expand/collapse: initially collapsed (show first 2 articles)
- If thread has ≤2 articles: no collapse, show all
- Expand: "Show N more" button
- Collapse: "Show less" button

#### Step 5: Update `page.tsx` render

Replace thread group `<section>` with `<ThreadSection>`.

### Files to Modify

| File | Action | Changes |
|------|--------|---------|
| `src/lib/news-service.ts` | Modify | Add `getThreadsByIds()` |
| `src/app/news/page.tsx` | Modify | Heat score, sort, thread titles, use ThreadSection |
| `src/app/news/_components/ThreadSection.tsx` | **Create** | Client component: expand/collapse + title |

### Heat Score Formula

```
heat = Σ (importance_weight × e^(-0.3 × days_old))

importance_weight: must_read=3, worth_reading=2, optional=1
time_decay half-life: ~2.3 days
```

### Verification

1. `npm run lint` — no errors
2. `npm run build` — no type errors
3. Visual: thread groups show real titles, sorted by heat, collapsible
4. Edge cases: 1-article threads, missing title, 0 threaded articles (fallback layout)

---

## Future Phases (Deferred)

These are ideas for later, not currently planned:

- **Detail page components**: RelatedArticles, MiniTimeline, MoreLikeThis
- **Stories tab**: Cross-day thread timeline view
- **Search tab**: Semantic search via pgvector
- **Thread title auto-refresh**: Gemini regenerates title at 10/25/50 article milestones
- **Sticky BriefingPlayer**: Compact mode on scroll
