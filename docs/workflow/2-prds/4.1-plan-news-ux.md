<!-- Created: 2026-02-18 -->
# Plan: News Frontend Phase 6-8

## Scope (User-confirmed)

3 features only. No importance filter, no Stories/Search tabs.

1. **Thread title** — Show `wsj_story_threads.title` instead of generic "N articles"
2. **Expand/collapse** — Thread groups collapsible (show lead article, expand to see all)
3. **Heat score ranking** — Sort thread groups by heat score (hottest first)

---

## Current State

### `src/app/news/page.tsx` (Server Component)
- `groupByThread()` function (line 48-80) groups articles by `thread_id`
- Thread section renders at line 287-314:
  ```tsx
  <h2>
    {group.articles[0]?.feed_name
      ? `${group.articles.length} articles`   // ← WRONG: shows count, not title
      : 'Related Stories'}
  </h2>
  ```
- No expand/collapse — all articles always visible
- No heat score computation or sorting
- Thread groups rendered in arbitrary Map iteration order

### `src/lib/news-service.ts`
- `getStoryThread(threadId)` exists (line 294-303) — fetches single thread by ID
- `getNewsItems()` returns articles with `thread_id` but NOT thread title
- `StoryThread` interface: `{ id, title, member_count, first_seen, last_seen }`
- No batch thread fetch method

### Heat Score Formula (from `docs/4-news-threading.md`)
```
heat = Σ (importance_weight × e^(-0.3 × days_old))

importance_weight: must_read=3, worth_reading=2, optional=1
time_decay: e^(-0.3 × days_old) → half-life ~2.3 days
```
Computed at query time, not stored in DB.

---

## Implementation Plan

### Step 1: Add `getThreadsByIds()` to news-service.ts

Batch fetch thread metadata for all thread IDs in one query.

```typescript
async getThreadsByIds(threadIds: string[]): Promise<Map<string, StoryThread>> {
  const { data } = await this.supabase
    .from('wsj_story_threads')
    .select('id, title, member_count, first_seen, last_seen')
    .in('id', threadIds)
  // Return as Map<id, StoryThread>
}
```

### Step 2: Add `computeHeatScore()` utility in page.tsx

Pure function, no DB needed. Takes thread's articles, returns heat number.

```typescript
function computeHeatScore(articles: NewsItem[]): number {
  const weights = { must_read: 3, worth_reading: 2, optional: 1 }
  const now = Date.now()
  return articles.reduce((sum, a) => {
    const daysOld = (now - new Date(a.published_at).getTime()) / 86400000
    const w = weights[a.importance as keyof typeof weights] ?? 1
    return sum + w * Math.exp(-0.3 * daysOld)
  }, 0)
}
```

### Step 3: Update page.tsx — fetch titles + sort by heat

In `NewsPage()`:
1. After `groupByThread()`, collect all thread IDs
2. Call `service.getThreadsByIds(threadIds)`
3. Compute heat score per group
4. Sort groups by heat descending
5. Pass thread title + heat + articles to a new client component

### Step 4: Create `ThreadSection.tsx` (Client Component)

New file: `src/app/news/_components/ThreadSection.tsx`

```tsx
'use client'

interface ThreadSectionProps {
  title: string
  articleCount: number
  heat: number
  children: React.ReactNode  // ArticleCard list
}

// - Shows thread title + article count badge
// - Expand/collapse: initially collapsed (show first 2 articles)
// - Click to expand all articles
// - Collapse button at bottom
```

### Step 5: Update page.tsx render — use ThreadSection

Replace the current thread group `<section>` with:
```tsx
<ThreadSection
  title={threadMeta.get(group.threadId)?.title ?? `${group.articles.length} articles`}
  articleCount={group.articles.length}
  heat={computeHeatScore(group.articles)}
>
  {group.articles.map(item => <ArticleCard ... />)}
</ThreadSection>
```

---

## Files to Modify

| File | Action | Changes |
|------|--------|---------|
| `src/lib/news-service.ts` | Modify | Add `getThreadsByIds()` method |
| `src/app/news/page.tsx` | Modify | Add `computeHeatScore()`, fetch thread titles, sort by heat, use ThreadSection |
| `src/app/news/_components/ThreadSection.tsx` | **Create** | Client component with expand/collapse + title + heat indicator |

---

## UX Details

### Thread title display
- `wsj_story_threads.title` (LLM-generated, e.g., "Fed Rate Decision", "Trump Tariffs")
- Fallback: `"${count} Related Articles"` if title fetch fails

### Expand/collapse behavior
- Default: collapsed (show first 2 articles)
- If thread has ≤2 articles: no collapse, show all
- Expand button: "Show N more articles"
- Collapse button: "Show less" (scroll back to section top)

### Heat score display
- No numeric display to user
- Used only for sort order (hottest threads at top)
- Ungrouped articles section always at bottom

---

## Verification

1. `npm run lint` — no errors
2. `npm run build` — no type errors
3. Visual check: thread groups show real titles, sorted by heat, collapsible
4. Edge cases: threads with 1 article, threads with no title in DB, 0 threaded articles (fallback layout)
