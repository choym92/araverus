<!-- Created: 2026-02-17 -->
# Plan: News Page UX ‚Äî Phase 1 & 2

## Goal

Transform the flat 30-article WSJ-style news page into a clustered, keyword-filterable feed with an article detail page ‚Äî powered by stored embeddings ‚Äî enabling story discovery, related articles, and historical "More Like This."

---

## Current State

**Frontend:**
- `src/app/news/page.tsx` ‚Äî Server Component, WSJ 3-column layout (left/center/right)
- `src/app/news/_components/ArticleCard.tsx` ‚Äî 3 variants: featured, standard, compact
- `src/app/news/_components/NewsShell.tsx` ‚Äî Client shell (sidebar + header)
- `src/app/news/_components/BriefingPlayer.tsx` ‚Äî Audio player (currently in center col)
- `src/app/news/layout.tsx` ‚Äî Metadata only
- `src/lib/news-service.ts` ‚Äî `NewsService` class: `getNewsItems()`, `getLatestBriefings()`, `getBriefingSources()`

**Pipeline (Python, runs daily on Mac Mini):**
- `scripts/llm_analysis.py` ‚Äî GPT-4o-mini analysis, generates `summary`, `sentiment`, entities, etc. Stored in `wsj_llm_analysis`
- `scripts/embedding_rank.py` ‚Äî Uses `all-MiniLM-L6-v2` for article matching (writes `embedding_score` float to `wsj_crawl_results`, does NOT store vectors)

**Database:**
- `wsj_items` ‚Äî articles (no `cluster_id` yet)
- `wsj_llm_analysis` ‚Äî analysis output (no `keywords` column yet)
- No `wsj_embeddings` table, no `wsj_story_clusters` table
- pgvector extension: not yet enabled on this Supabase project

---

## Proposed Approach

### Phase 1: Keywords + Embeddings + Clustering

#### Step 1a ‚Äî Add `keywords` to LLM prompt

Modify `scripts/llm_analysis.py`:
- Add `"keywords": ["<2-4 topic keywords>"]` to the existing LLM JSON prompt
- Add `ALTER TABLE wsj_llm_analysis ADD COLUMN keywords TEXT[]` migration
- Minimal change ‚Äî same API call, same model, +1 field in response

#### Step 1b ‚Äî Enable pgvector + create `wsj_embeddings` table

New migration `supabase/migrations/007_embeddings_clusters.sql`:
```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE wsj_embeddings (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    item_id     UUID NOT NULL REFERENCES wsj_items(id) UNIQUE,
    embedding   vector(384),
    model_name  TEXT NOT NULL DEFAULT 'all-MiniLM-L6-v2',
    input_text  TEXT,
    created_at  TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX ON wsj_embeddings USING ivfflat (embedding vector_cosine_ops) WITH (lists = 20);

CREATE TABLE wsj_story_clusters (
    id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    date          DATE NOT NULL,
    headline      TEXT NOT NULL,
    color         TEXT,
    article_count INT DEFAULT 0,
    created_at    TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE wsj_items ADD COLUMN cluster_id UUID REFERENCES wsj_story_clusters(id);
```

#### Step 1c ‚Äî New pipeline script: `scripts/embed_and_cluster.py`

New Python script (runs after `llm_analysis.py` in daily pipeline):
1. Load `all-MiniLM-L6-v2` (already in `requirements.txt`)
2. Fetch today's processed articles (`wsj_items JOIN wsj_llm_analysis WHERE processed=true AND date=today`)
3. Embed `title + summary` for each article
4. Store vectors in `wsj_embeddings`
5. Run agglomerative clustering (sklearn, `distance_threshold=0.5`, cosine)
6. LLM call to generate a headline per cluster (gpt-4o-mini, batch all cluster titles)
7. Store clusters in `wsj_story_clusters`, update `wsj_items.cluster_id`

#### Step 1d ‚Äî Update `NewsService` to serve clusters + keywords

Modify `src/lib/news-service.ts`:
- Add `getClusters(date, category?)` ‚Äî returns clusters with their articles, keywords
- Update `getNewsItems()` to include `keywords` from `wsj_llm_analysis`

#### Step 1e ‚Äî Rebuild `/news` page layout

Modify `src/app/news/page.tsx`:
- Replace 3-column layout with cluster-based layout
- Category filter (existing) ‚Üí now filters which clusters are shown
- Keyword filter bar (new, derived from today's articles' keywords)
- Audio player: extract into hero section (collapses to sticky on scroll)

#### Step 1f ‚Äî New/modified frontend components

| Component | Action | Description |
|-----------|--------|-------------|
| `_components/BriefingPlayer.tsx` | Modify | Add `isSticky` prop, compact sticky variant |
| `_components/ClusterCard.tsx` | Create | Collapsible story cluster with lead article + sub-list |
| `_components/KeywordFilterBar.tsx` | Create | Keyword pills, click to filter clusters |
| `_components/CategoryFilterBar.tsx` | Modify (existing nav) | Integrate with cluster filtering |
| `_components/ArticleCard.tsx` | Modify | Add keyword pills display |
| `NewsShell.tsx` | Modify | Add sticky player logic + tab bar |

---

### Phase 2: Article Detail + Hub-Spoke + More Like This

#### Step 2a ‚Äî New route: `src/app/news/[id]/page.tsx`

Server Component:
- Fetch article by `id` from `wsj_items JOIN wsj_llm_analysis`
- Fetch related articles (pgvector nearest neighbor, same day, limit 6)
- Fetch mini timeline (articles in same `cluster_id` across last 14 days, limit 5)
- Fetch "More Like This" (pgvector nearest neighbor, last 90 days, excluding same day, limit 5)
- Article cards link to `/news/[id]` instead of external URL

#### Step 2b ‚Äî Update `NewsService`

Add to `src/lib/news-service.ts`:
- `getArticleById(id)` ‚Äî single article with full metadata
- `getRelatedArticles(itemId, date, limit)` ‚Äî pgvector same-day nearest neighbor
- `getMoreLikeThis(itemId, limit, daysBack)` ‚Äî pgvector cross-time nearest neighbor
- `getMiniTimeline(clusterId, limit)` ‚Äî articles in thread across days

#### Step 2c ‚Äî Update article card links

Modify `src/app/news/page.tsx` + `ArticleCard.tsx`:
- Article clicks ‚Üí `/news/[id]` instead of direct external link
- Keep "Read original ‚Üí" as secondary link inside detail page

#### Step 2d ‚Äî New detail page components

| Component | Action | Description |
|-----------|--------|-------------|
| `src/app/news/[id]/page.tsx` | Create | Server Component, article detail |
| `_components/RelatedArticles.tsx` | Create | Hub-spoke related articles grid |
| `_components/MiniTimeline.tsx` | Create | 3-5 entry story timeline strip |
| `_components/MoreLikeThis.tsx` | Create | Historical similar articles list |

---

## Files to Change

| File | Action | Description |
|------|--------|-------------|
| `scripts/llm_analysis.py` | Modify | Add `keywords` field to LLM prompt + DB save |
| `scripts/embed_and_cluster.py` | Create | New pipeline step: embed + cluster daily articles |
| `scripts/requirements.txt` | Modify | Verify scikit-learn is present (for clustering) |
| `scripts/run_pipeline.sh` | Modify | Add `embed_and_cluster.py` call after `llm_analysis` |
| `supabase/migrations/007_embeddings_clusters.sql` | Create | pgvector, wsj_embeddings, wsj_story_clusters, alter wsj_items |
| `docs/schema.md` | Modify | Document new tables + columns |
| `src/lib/news-service.ts` | Modify | Add cluster, related, timeline, detail queries |
| `src/app/news/page.tsx` | Modify | Replace 3-col layout with cluster layout + tabs |
| `src/app/news/layout.tsx` | Modify | Update metadata |
| `src/app/news/_components/BriefingPlayer.tsx` | Modify | Add sticky variant |
| `src/app/news/_components/ArticleCard.tsx` | Modify | Add keyword pills, change link to `/news/[id]` |
| `src/app/news/_components/ClusterCard.tsx` | Create | Collapsible cluster component |
| `src/app/news/_components/KeywordFilterBar.tsx` | Create | Keyword filter pills bar |
| `src/app/news/_components/NewsShell.tsx` | Modify | Sticky player + tab navigation |
| `src/app/news/[id]/page.tsx` | Create | Article detail page |
| `src/app/news/[id]/_components/RelatedArticles.tsx` | Create | Hub-spoke related |
| `src/app/news/[id]/_components/MiniTimeline.tsx` | Create | Mini story timeline |
| `src/app/news/[id]/_components/MoreLikeThis.tsx` | Create | Historical similar |

---

## Database Changes

| Change | SQL | Migration |
|--------|-----|-----------|
| Enable pgvector | `CREATE EXTENSION IF NOT EXISTS vector` | 007 |
| New table `wsj_embeddings` | `vector(384)` column, ivfflat index | 007 |
| New table `wsj_story_clusters` | date, headline, color, article_count | 007 |
| Add `wsj_items.cluster_id` | FK ‚Üí wsj_story_clusters | 007 |
| Add `wsj_llm_analysis.keywords` | `TEXT[]` | 007 |

---

## Execution Order

```
1. DB migration (007) ‚Äî enable pgvector, create tables
2. Pipeline changes ‚Äî llm_analysis.py (keywords) + embed_and_cluster.py
3. Test pipeline locally on Mac Mini with today's articles
4. NewsService updates ‚Äî new query methods
5. Phase 1 frontend ‚Äî cluster layout, keyword filter, sticky player
6. Phase 2 frontend ‚Äî /news/[id] detail page + related + timeline + more like this
7. Lint + build check after each major step
```

---

## Risks & Considerations

| Risk | Severity | Mitigation |
|------|----------|-----------|
| pgvector not enabled on Supabase project | High | Enable via migration before writing any embedding code. Supabase supports pgvector on all tiers. |
| Cluster quality ‚Äî too few or too many clusters | Medium | `distance_threshold=0.5` is a starting point. Needs tuning with real data. Add logging in pipeline to inspect cluster counts. |
| Pipeline adds ~10-30s for embedding + clustering | Low | Runs daily batch ‚Äî acceptable. Not user-facing latency. |
| Missing embeddings for articles processed before Phase 1 | Medium | Build `backfill_embeddings.py` alongside the main script. Run once to embed all historical articles. |
| `keywords` column on existing `wsj_llm_analysis` rows = NULL | Low | Frontend handles null gracefully. Old articles show no keyword pills. New articles onward will have keywords. |
| Related articles query slow at scale | Low | ivfflat index handles well under 10K rows. At 50 articles/day, fine for 1+ year. |
| Sticky player + tab bar adds layout complexity | Medium | Sticky requires `position: sticky` or JS scroll listener. Keep in `NewsShell` (already client component). |
| 3-column ‚Üí cluster layout is a breaking visual change | Medium | Revert path: git history on `feature/news-frontend` branch. |

---

## Open Questions

| # | Question | Decision Needed Before |
|---|----------|----------------------|
| 1 | Does Supabase project have pgvector enabled already? Need to check Supabase dashboard. | Step 1b |
| 2 | scikit-learn in `requirements.txt`? Need to verify before writing clustering code. | Step 1c |
| 3 | How to handle cluster coloring ‚Äî manual palette or auto-assigned? | Step 1e frontend |
| 4 | Tab routing: should `[üì∞ Today]` `[üìà Stories]` `[üîç Search]` use URL params (`?tab=stories`) or client-side state? URL params = shareable links, client state = simpler. | Step 1e frontend |
| 5 | Should article detail page `/news/[id]` be in `next.config.ts` image domain allowlist? (for `top_image` rendering) | Step 2a |
